{% extends "base" %}
{% block title %}Search Results{% endblock %}
{% block content %}
<div class="search-form">
    <h2>üîç Search HyperZoekt Index</h2>
    <form id="search-form">
        <input type="text" id="query" name="q" class="search-input"
            placeholder="Search for functions, classes, files..." required>
        <input type="text" id="repo" name="repo" class="search-input" placeholder="Filter by repository (optional)">
        <button type="submit" class="btn">Search</button>
    </form>
</div>

<div id="results" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h2>üìã Search Results</h2>
        </div>
        <div class="card-body">
            <div id="results-count"></div>
            <ul id="results-list" class="entity-list"></ul>
        </div>
    </div>
</div>

<script>
    // Function to get CSS class based on entity kind
    function getKindClass(kind) {
        if (kind.includes('function') || kind.includes('method')) {
            return 'entity-function';
        } else if (kind.includes('class') || kind.includes('struct') || kind.includes('interface') || kind.includes('trait')) {
            return 'entity-class';
        } else if (kind.includes('enum')) {
            return 'entity-enum';
        } else if (kind.includes('module') || kind.includes('namespace')) {
            return 'entity-module';
        } else if (kind.includes('variable') || kind.includes('constant') || kind.includes('field')) {
            return 'entity-variable';
        } else if (kind.includes('macro')) {
            return 'entity-macro';
        } else {
            return 'entity-other';
        }
    }

    // Function to get CSS class based on programming language
    function getLanguageClass(language) {
        const lang = language.toLowerCase();
        if (lang === 'rust' || lang === 'rs') {
            return 'lang-rust';
        } else if (lang === 'python' || lang === 'py') {
            return 'lang-python';
        } else if (lang === 'javascript' || lang === 'js') {
            return 'lang-javascript';
        } else if (lang === 'typescript' || lang === 'ts') {
            return 'lang-typescript';
        } else if (lang === 'go') {
            return 'lang-go';
        } else if (lang === 'java') {
            return 'lang-java';
        } else if (lang === 'cpp' || lang === 'c++') {
            return 'lang-cpp';
        } else if (lang === 'c') {
            return 'lang-c';
        } else if (lang === 'csharp' || lang === 'c#') {
            return 'lang-csharp';
        } else if (lang === 'swift') {
            return 'lang-swift';
        } else if (lang === 'kotlin') {
            return 'lang-kotlin';
        } else if (lang === 'scala') {
            return 'lang-scala';
        } else if (lang === 'ruby') {
            return 'lang-ruby';
        } else if (lang === 'php') {
            return 'lang-php';
        } else if (lang === 'html') {
            return 'lang-html';
        } else if (lang === 'css') {
            return 'lang-css';
        } else {
            return 'lang-other';
        }
    }

    // Function to create a GitHub link from file path
    function createFileLink(filePath, startLine) {
        // Extract repository name from file path (first part before /)
        const pathParts = filePath.split('/');
        const repoName = pathParts[0];
        const fileName = pathParts.slice(1).join('/');

        // Create GitHub URL with proper URL encoding to prevent XSS
        const encodedRepoName = encodeURIComponent(repoName);
        const encodedFileName = encodeURIComponent(fileName);
        const githubUrl = `https://github.com/${encodedRepoName}/${encodedFileName}`;
        const urlWithLine = startLine ? `${githubUrl}#L${startLine}` : githubUrl;

        // Return HTML link
        return `<a href="${urlWithLine}" target="_blank" style="color: #0366d6; text-decoration: none;">${filePath}${startLine ? ':' + startLine : ''}</a>`;
    }

    document.getElementById('search-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const query = document.getElementById('query').value;
        const repo = document.getElementById('repo').value;

        const params = new URLSearchParams({ q: query });
        if (repo) {
            params.append('repo', repo);
        }

        try {
            const response = await fetch(`/api/search?${params}`);
            const results = await response.json();

            const resultsDiv = document.getElementById('results');
            const resultsList = document.getElementById('results-list');
            const resultsCount = document.getElementById('results-count');

            resultsCount.textContent = `Found ${results.length} results`;
            resultsList.innerHTML = '';

            results.forEach(entity => {
                const li = document.createElement('li');
                li.className = 'entity-item';

                // Add kind-specific CSS class for background coloring
                const kindClass = getKindClass(entity.kind);
                if (kindClass) {
                    li.classList.add(kindClass);
                }

                li.innerHTML = `
                <div class="entity-name">
                    <a href="/entity/${entity.stable_id}" style="color: #333; text-decoration: none;">
                        ${entity.name}
                    </a>
                    <span class="badge badge-${getKindClass(entity.kind)}">${entity.kind}</span>
                    <span class="badge ${getLanguageClass(entity.language)}">${entity.language}</span>
                </div>
                <div class="entity-meta">
                    üìÑ ${createFileLink(entity.file, entity.start_line)}
                    ${entity.end_line && entity.start_line ? `-${entity.end_line}` : ''}
                    ${entity.parent ? ` ‚Ä¢ üì¶ ${entity.parent}` : ''}
                </div>
                ${entity.signature ? `<div class="entity-signature"><code>${entity.signature}</code></div>` : ''}
                ${entity.calls && entity.calls.length > 0 ? `<div class="entity-calls">üìû Calls: ${entity.calls.slice(0, 3).join(', ')}${entity.calls.length > 3 ? ` +${entity.calls.length - 3} more` : ''}</div>` : ''}
                ${entity.doc ? `<div class="entity-doc">${entity.doc.substring(0, 150)}${entity.doc.length > 150 ? '...' : ''}</div>` : ''}
            `;

                resultsList.appendChild(li);
            });

            resultsDiv.style.display = 'block';
        } catch (error) {
            console.error('Search failed:', error);
            alert('Search failed. Please try again.');
        }
    });
</script>
{% endblock %}