{% extends "base" %}
{% block title %}Search Results{% endblock %}
{% block content %}
<div class="search-form">
    <h2>üîç Search HyperZoekt Index</h2>
    <form id="search-form">
        <input type="text" id="query" name="q" class="search-input"
            placeholder="Search for functions, classes, files..." required>
        <div id="repo-multiselect" class="search-input"
            style="position:relative; padding:6px; background:var(--input-bg); border-radius:6px; display:flex; gap:6px; align-items:center; flex-wrap:wrap; min-height:40px;">
            <div id="repo-tags" style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;"></div>
            <input id="repo-input" placeholder="Type to search repositories..."
                style="border:none; background:transparent; outline:none; flex:1; min-width:160px; padding:6px;">
            <div id="repo-options"
                style="position:absolute; left:6px; right:6px; top:46px; max-height:220px; overflow:auto; background:var(--panel); border:1px solid var(--input-border); border-radius:6px; display:none; z-index:50;">
            </div>
        </div>
        <button type="submit" class="btn">Search</button>
    </form>
</div>

<div id="results" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h2>üìã Search Results</h2>
        </div>
        <div class="card-body">
            <div id="results-count"></div>
            <ul id="results-list" class="entity-list"></ul>
        </div>
    </div>
</div>

<script type="module">
    import { createMultiselect } from '/static/common/multiselect.js';

    // Helper: kind -> class
    function getKindClass(kind) {
        if (!kind) return 'entity-other';
        if (kind.includes('function') || kind.includes('method')) return 'entity-function';
        if (kind.includes('class') || kind.includes('struct') || kind.includes('interface') || kind.includes('trait')) return 'entity-class';
        if (kind.includes('enum')) return 'entity-enum';
        if (kind.includes('module') || kind.includes('namespace')) return 'entity-module';
        if (kind.includes('variable') || kind.includes('constant') || kind.includes('field')) return 'entity-variable';
        if (kind.includes('macro')) return 'entity-macro';
        return 'entity-other';
    }

    function getLanguageClass(language) {
        if (!language) return 'lang-other';
        const lang = language.toLowerCase();
        if (lang === 'rust' || lang === 'rs') return 'lang-rust';
        if (lang === 'python' || lang === 'py') return 'lang-python';
        if (lang === 'javascript' || lang === 'js') return 'lang-javascript';
        if (lang === 'typescript' || lang === 'ts') return 'lang-typescript';
        if (lang === 'go') return 'lang-go';
        if (lang === 'java') return 'lang-java';
        if (lang === 'cpp' || lang === 'c++') return 'lang-cpp';
        if (lang === 'c') return 'lang-c';
        if (lang === 'csharp' || lang === 'c#') return 'lang-csharp';
        if (lang === 'swift') return 'lang-swift';
        if (lang === 'kotlin') return 'lang-kotlin';
        if (lang === 'scala') return 'lang-scala';
        if (lang === 'ruby') return 'lang-ruby';
        if (lang === 'php') return 'lang-php';
        if (lang === 'html') return 'lang-html';
        if (lang === 'css') return 'lang-css';
        return 'lang-other';
    }

    function createFileLink(filePath, startLine) {
        const pathParts = (filePath || '').split('/');
        const repoName = pathParts[0] || '';
        const fileName = pathParts.slice(1).join('/');
        const encodedRepoName = encodeURIComponent(repoName);
        const encodedFileName = encodeURIComponent(fileName);
        const githubUrl = `https://github.com/${encodedRepoName}/${encodedFileName}`;
        const urlWithLine = startLine ? `${githubUrl}#L${startLine}` : githubUrl;
        return `<a href="${urlWithLine}" target="_blank" style="color: #0366d6; text-decoration: none;">${filePath}${startLine ? ':' + startLine : ''}</a>`;
    }

    // Instantiate shared multiselect
    const searchMultiselect = createMultiselect({ inputId: 'repo-input', tagsId: 'repo-tags', optionsContainerId: 'repo-options', storageKey: 'hz_recent_repos' });
    window.searchMultiselect = searchMultiselect;

    // Submit handler uses the multiselect instance
    document.getElementById('search-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const queryEl = document.getElementById('query');
        const query = queryEl.value;
        if (!query || query.trim().length === 0) {
            queryEl.classList.add('input-error');
            alert('Please enter a search term.');
            return;
        }
        const selected = (searchMultiselect && typeof searchMultiselect.getSelected === 'function') ? searchMultiselect.getSelected() : [];
        const params = new URLSearchParams();
        params.append('q', query);
        if (selected && selected.length) {
            for (const r of selected) params.append('repo', r);
            localStorage.setItem('hz_recent_repos', JSON.stringify(selected));
        }
        try {
            const response = await fetch(`/api/search?${params.toString()}`);
            const data = await response.json();
            const results = Array.isArray(data) ? data : (data.results || []);
            const elapsedMs = (data && typeof data === 'object' && 'elapsed_ms' in data) ? data.elapsed_ms : null;

            const resultsDiv = document.getElementById('results');
            const resultsList = document.getElementById('results-list');
            const resultsCount = document.getElementById('results-count');

            resultsCount.textContent = `Found ${results.length} results${elapsedMs !== null ? ' in ' + elapsedMs + ' ms' : ''}`;
            resultsList.innerHTML = '';

            results.forEach(entity => {
                const li = document.createElement('li');
                li.className = 'entity-item';
                const kindClass = getKindClass(entity.kind);
                if (kindClass) { li.classList.add(kindClass); }
                const filePathForDisplay = entity.source_display ? entity.source_display : (entity.file || '');
                const fileLinkHtml = entity.source_url
                    ? `<a href="${entity.source_url}${entity.start_line ? '#L' + entity.start_line : ''}" target="_blank" style="color: #0366d6; text-decoration: none;">${filePathForDisplay}${entity.start_line ? ':' + entity.start_line : ''}</a>`
                    : createFileLink(filePathForDisplay, entity.start_line);

                li.innerHTML = `
                    <div class="entity-name">
                        <a href="/entity/${entity.stable_id}" style="color: #333; text-decoration: none;">
                            ${entity.name}
                        </a>
                        <span class="badge badge-${getKindClass(entity.kind)}">${entity.kind}</span>
                        <span class="badge ${getLanguageClass(entity.language)}">${entity.language}</span>
                    </div>
                    <div class="entity-meta">
                        üìÑ ${fileLinkHtml}
                        ${entity.end_line && entity.start_line ? `-${entity.end_line}` : ''}
                        ${entity.parent ? ` ‚Ä¢ üì¶ ${entity.parent}` : ''}
                    </div>
                    ${entity.signature ? `<div class="entity-signature"><code>${entity.signature}</code></div>` : ''}
                    ${entity.calls && entity.calls.length > 0 ? `<div class="entity-calls">üìû Calls: ${entity.calls.slice(0, 3).join(', ')}${entity.calls.length > 3 ? ` +${entity.calls.length - 3} more` : ''}</div>` : ''}
                    ${entity.doc ? `<div class="entity-doc">${entity.doc.substring(0, 150)}${entity.doc.length > 150 ? '...' : ''}</div>` : ''}
                `;

                resultsList.appendChild(li);
            });

            resultsDiv.style.display = 'block';
        } catch (error) {
            console.error('Search failed:', error);
            alert('Search failed. Please try again.');
        }
    });
</script>
{% endblock %}